---
title: "script_2.1_demux_qc_20250805_055"
author: "GKM"
date: "2025-08-11"
output:
  html_document:
    keep_md: TRUE
---

This script is a pipeline to do pre-processing 20250805_run1 samples from donor 55. It will explore the seurat file, plot and save various plots and determine the QC metrics for both PBMC and T cell sorted populations. 
However, to save the processed seurat object, should run as a batch script where all donors are processed and merged, found at ~/R/scCHANTS/script_2.1_save_processed_20250805_rds.R

* unzip files
* load into a seurat object
* (in future scripts will need to do data integration?)
* filter and quality control
* normalisation
* (batch effect correction)
* feature selection
* find cluster markers
* dimensionality reduction

Before running bear in mind all plots will automatically be saved, I recommend copying plots to your OneDrive folder as you generate them in case of overwriting (though they should be the same!)
Can also search for " # ggsave" and replace with "## ggsave" or vice versa

# Donor 55

# Script 2.1 Load and HTO demultiplex

## Load packages
```{r}
#library("R.utils")    # need for decompressing files
library("dplyr")
library("Seurat")
library("ggplot2")
library("patchwork")
```

## Create file path for saving plots
Must create this directory and sub-directories e.g. demultiplex, QC, PCA
```{r}
#file_path <- "/scratch/prj/id_hill_sims_wellcda/scCHANTS/20250805_run1/plots"
file_path <- "/Users/k2477939/Library/CloudStorage/OneDrive-King\'sCollegeLondon/General\ -\ Laboratory\ of\ Molecular\ Immunotherapy\ and\ Antibiotics/Data/Georgia\ Miller/scCHANTS/20250805_run1/plots/"
```


## Load data & rename HTO and ADTs
```{r}
## Decompress the files

# only need to do once
# gunzip("/scratch/prj/id_hill_sims_wellcda/scCHANTS/20250805_run1/20250805_run1_055/matrix.mtx.gz", temporary = TRUE, remove = FALSE)
# gunzip("/scratch/prj/id_hill_sims_wellcda/scCHANTS/20250805_run1/20250805_run1_055/barcodes.tsv.gz", temporary = TRUE, remove = FALSE)
# gunzip("/scratch/prj/id_hill_sims_wellcda/scCHANTS/20250805_run1/20250805_run1_055/features.tsv.gz", temporary = TRUE, remove = FALSE)


## Load data

# load the unzipped files
# gene.column = 2 gives gene symbol/name instead of ENSEMBL ID
#scCHANTS_055_data <- Read10X(data.dir = "/scratch/prj/id_hill_sims_wellcda/scCHANTS/20250805_run1/20250805_run1_055/", gene.column=2)
scCHANTS_055_data <- Read10X(data.dir = "/Users/k2477939/Library/CloudStorage/OneDrive-King\'sCollegeLondon/General\ -\ Laboratory\ of\ Molecular\ Immunotherapy\ and\ Antibiotics/Data/Georgia\ Miller/scCHANTS/20250805_run1/donor_055/20250805_run1_055", gene.column=2)

# create seurat object
# could add arguments for min.cells or min.features to be included
scCHANTS_055 <- CreateSeuratObject(counts = scCHANTS_055_data, project = "scCHANTS_055")

Assays(scCHANTS_055)
Layers(scCHANTS_055[["RNA"]])


## Rename HTO and ADT ids

# add HTO and ADT assay to the seurat object as it is by default ignored by CreateSeuratObject
# extract feature names
HTO_names <- rownames(scCHANTS_055_data$`Antibody Capture`) [1:13]
ADT_names <- rownames(scCHANTS_055_data$`Antibody Capture`) [14:17]

# extract count matrices
HTO_counts <- scCHANTS_055_data$`Antibody Capture` [HTO_names, , drop=FALSE]
ADT_counts <- scCHANTS_055_data$`Antibody Capture` [ADT_names, , drop=FALSE]

# check names and order
rownames(HTO_counts)
rownames(ADT_counts)

# create mapping from long to short names. using - not _ as cannot have underscores in seurat object names
name_to_id <- c(
  "TotalSeq™-C0251 anti-human Hashtag 1 Antibody"  = "HTO-1",
  "TotalSeq™-C0252 anti-human Hashtag 2 Antibody"  = "HTO-2",
  "TotalSeq™-C0253 anti-human Hashtag 3 Antibody"  = "HTO-3",
  "TotalSeq™-C0254 anti-human Hashtag 4 Antibody"  = "HTO-4",
  "TotalSeq™-C0255 anti-human Hashtag 5 Antibody"  = "HTO-5",
  "TotalSeq™-C0256 anti-human Hashtag 6 Antibody"  = "HTO-6",
  "TotalSeq™-C0257 anti-human Hashtag 7 Antibody"  = "HTO-7",
  "TotalSeq™-C0258 anti-human Hashtag 8 Antibody"  = "HTO-8",
  "TotalSeq™-C0259 anti-human Hashtag 9 Antibody"  = "HTO-9",
  "TotalSeq™-C0260 anti-human Hashtag 10 Antibody" = "HTO-10",
  "TotalSeq™-C0296 anti-human Hashtag 11 Antibody" = "HTO-11",
  "TotalSeq™-C0262 anti-human Hashtag 12 Antibody" = "HTO-12",
  "TotalSeq™-C0263 anti-human Hashtag 13 Antibody" = "HTO-13",
  
  # ADTs
  "TotalSeq-C anti human CD14 (clone M5E2, cat 301859)"             = "ADT-CD14",
  "TotalSeq-C anti human CD16 (clone 3G8 cat 302065)"               = "ADT-CD16",
  "TotalSeq™-C0045 anti-human CD4 Antibody (clone SK3, cat 344651)" = "ADT-CD4",
  "TotalSeq™-C0046 anti-human CD8 Antibody (clone SK1, cat 344753)" = "ADT-CD8"
)

# rename the rows (features) using the mapping
rownames(HTO_counts) <- unname(name_to_id[rownames(HTO_counts)])
rownames(ADT_counts) <- unname(name_to_id[rownames(ADT_counts)])

# check names have changed
rownames(HTO_counts)
rownames(ADT_counts)


## Add HTO and ADT assays to seurat object

# add HTO assay
scCHANTS_055[["HTO"]] <- CreateAssayObject(counts = HTO_counts)

# add ADT assay
scCHANTS_055[["ADT"]] <- CreateAssayObject(counts = ADT_counts)

# validate assays were added
Assays(scCHANTS_055)

# validate layers
Layers(scCHANTS_055)

# check default assay
DefaultAssay(scCHANTS_055)

# if needed, can change default assay
DefaultAssay(scCHANTS_055) <- "RNA"

# check number of cells (samples) and features looks right
scCHANTS_055@assays$RNA
scCHANTS_055@assays$HTO
scCHANTS_055@assays$ADT
```


```{r}
# free space
rm(scCHANTS_055_data, ADT_counts, HTO_counts, ADT_names, HTO_names, name_to_id)
```

## Demultiplex HTOs

Should check in whether to normalise across features or cells (use margin argument)

https://satijalab.org/seurat/articles/hashing_vignette

HTODemux:

* Perform a k-medoid clustering on the normalized HTO values, which initially separates cells into K(# of samples)+1 clusters.
* Calculate a ‘negative’ distribution for HTO. For each HTO, the cluster with the lowest average value is used as the negative group.
* For each HTO, fit a negative binomial distribution to the negative cluster. 0.99 quantile of this distribution is used as a threshold.
* Based on these thresholds, each cell is classified as positive or negative for each HTO.
* Cells that are positive for more than one HTOs are annotated as doublets.

```{r}
# remove empty
scCHANTS_055$totRNA <- Matrix::colSums(scCHANTS_055@assays$RNA@layers$`counts.Gene Expression`)
scCHANTS_055$totHTO <- Matrix::colSums(scCHANTS_055@assays$HTO@counts)

FeatureScatter(scCHANTS_055, "totRNA", "totHTO") + ggtitle("RNA vs HTO per barcode")
VlnPlot(scCHANTS_055, features = c("totRNA","totHTO"), ncol = 2)

scCHANTS_055 <- subset(scCHANTS_055, subset = totRNA > 0 | totHTO > 0)

DefaultAssay(scCHANTS_055) <- "HTO"

# normalise HTO counts, standard is centered log-ratio (CLR) transformation
# can normalise across features (margin = 1) or across cells (margin = 2)
# comment on github forum satija lab says they recommend normalising across tags if variation between hash performances but since have very low signals, will try across cells
scCHANTS_055 <- NormalizeData(scCHANTS_055, assay = "HTO", normalization.method = "CLR", margin = 2)

# using default threshold (quantile of inferred negative distribution for each hashtag), default kfunc is clara (for fast k-medoids clustering on large applications, it is faster and more memory-efficient as it repeatedly samples subsets and clusters those)
scCHANTS_055 <- HTODemux(scCHANTS_055, assay = "HTO", positive.quantile = 0.99, kfunc = "clara")
```

### Visualise demultiplexing
```{r fig.dim = c(9,9)}
DefaultAssay(scCHANTS_055) <- "HTO"

# look at classification
table(scCHANTS_055$HTO_classification.global)
## check most are singlets

# look at how many counts for HTO
table(scCHANTS_055$HTO_maxID)

# check if ADT and HTO overlap, want most to be singlets with has_adt true
adt_mat <- GetAssayData(scCHANTS_055, assay = "ADT", layer = "counts")
has_adt <- colSums(adt_mat) > 0

table(scCHANTS_055$HTO_classification.global, has_adt)

# visualise enrichment for some HTOs, group cells based on the max HTO signal
d1 <- RidgePlot(scCHANTS_055, assay = "HTO", features = rownames(scCHANTS_055[["HTO"]])[1:4], ncol = 2, group.by = "HTO_maxID")
d1
# ggsave("HTO_1to4_ridgeplot_055.png", plot = d1, device = png, height = 25, width = 30, unit = "cm", path = paste0(file_path, "/demultiplex_055/") )


# look at pairs to see if mutually exclusive
d2 <- FeatureScatter(scCHANTS_055, feature1 = "HTO-1", feature2 = "HTO-2")
d2
# ggsave("HTO_1vs2_featureplot_055.png", plot = d2, device = png, height = 10, width = 15, unit = "cm", bg = "white", path = paste0(file_path, "/demultiplex_055/") )

# compare number UMIs
d3 <- VlnPlot(scCHANTS_055, features = "nCount_RNA", pt.size = 0.1, log = TRUE, group.by = "HTO_classification.global")
d3
# ggsave("HTO_nCount_RNA_055.png", plot = d3, device = png, height = 10, width = 18, unit = "cm", path = paste0(file_path, "/demultiplex_055/") )

```

Remove negative cells and look at HTO UMAPs
```{r fig.dim = c(9,9)}
scCHANTS_nonegs <- subset(scCHANTS_055, subset = HTO_classification.global != "Negative")
DefaultAssay(scCHANTS_055) <- "RNA"

# should check numbers of cells after subsetting as does not always subset every assay
length(Cells(scCHANTS_055))
length(Cells(scCHANTS_nonegs))
length(Cells(scCHANTS_nonegs[["RNA"]]))
length(Cells(scCHANTS_nonegs[["HTO"]]))
length(Cells(scCHANTS_nonegs[["ADT"]]))
## e.g. if counts.Gene Expression and counts.Antibody Capture are removed then RNA layer is no longer subsetted

# calculate a tSNE embedding of the HTO data
DefaultAssay(scCHANTS_nonegs) <- "HTO"

scCHANTS_nonegs <- ScaleData(scCHANTS_nonegs, features = rownames(scCHANTS_nonegs), verbose = TRUE)

scCHANTS_nonegs <- RunPCA(scCHANTS_nonegs, features = rownames(scCHANTS_nonegs), approx = FALSE)

scCHANTS_nonegs <- RunUMAP(scCHANTS_nonegs, dims = 1:8, perplexity = 100)

table(Idents(scCHANTS_nonegs))

d4 <- DimPlot(scCHANTS_nonegs, group.by = "hash.ID")
d4
# ggsave("HTO_hashID_umap_055.png", plot = d4, device = png, height = 10, width = 15, unit = "cm", path = paste0(file_path, "/demultiplex_055/") )

d5 <- DimPlot(scCHANTS_nonegs, group.by = "HTO_classification.global")
d5
# ggsave("HTO_classification_umap_055.png", plot = d5, device = png, height = 10, width = 15, unit = "cm", path = paste0(file_path, "/demultiplex_055/") )

```

```{r fig.dim = c(8,8)}
## Create a heatmap of HTO signals

d6 <- HTOHeatmap(scCHANTS_055, assay = "HTO", ncells = 5000)
d6
# ggsave("HTO_signal_heatmap_055.png", plot = d6, device = png, height = 10, width = 15, unit = "cm", path = paste0(file_path, "/demultiplex_055/") )
```

```{r}
## Visualise RNA clustering (just mock to check for batch effects, will do clustering etc later on after QC)

# extract the singlets
scCHANTS_singlets <- subset(scCHANTS_055, subset = HTO_classification.global == "Singlet")

# check subset worked
Idents(scCHANTS_singlets) <- "HTO_classification.global"
table(Idents(scCHANTS_singlets))

DefaultAssay(scCHANTS_singlets) <- "RNA"
DefaultLayer(scCHANTS_singlets[["RNA"]])
# select the top 1000 most variable features
scCHANTS_singlets <- FindVariableFeatures(scCHANTS_singlets, assay = "RNA", selection.method = "vst", layer = "counts.Gene Expression")

# normalise and scale RNA data, only scale the variable features here for efficiency
scCHANTS_singlets <- NormalizeData(scCHANTS_singlets, assay = "RNA", layer = "counts.Gene Expression")
scCHANTS_singlets <- ScaleData(scCHANTS_singlets, features = VariableFeatures(scCHANTS_singlets))

# run PCA
scCHANTS_singlets <- RunPCA(scCHANTS_singlets, features = VariableFeatures(scCHANTS_singlets))

# select the top 10 PCs for clustering and tSNE based on PCElbowPlot
scCHANTS_singlets <- FindNeighbors(scCHANTS_singlets, reduction = "pca", dims = 1:10)
scCHANTS_singlets <- FindClusters(scCHANTS_singlets, resolution = 0.6, verbose = FALSE)
scCHANTS_singlets <- RunUMAP(scCHANTS_singlets, reduction = "pca", dims = 1:10)

# project singlet identities on UMAP visualisation
d7 <- DimPlot(scCHANTS_singlets, group.by = "HTO_classification") +
  labs(title = "RNA UMAP HTO_classification 055")
d7
# ggsave("RNA_HTO_classification_UMAP_055.png", plot = d7, device = png, height = 10, width = 15, unit = "cm", path = paste0(file_path, "/demultiplex_055/") )

# show only a subset
subset1 <- subset(scCHANTS_singlets, subset = HTO_classification %in% c("HTO-1", "HTO-2", "HTO-3", "HTO-4") )

d8 <- DimPlot(subset1, group.by = "HTO_classification") +
  labs(title = "RNA UMAP HTO_classification on HTO-1:4 055")
d8
# ggsave("RNA_HTO_1to3_classification_UMAP_055.png", plot = d8, device = png, height = 10, width = 15, unit = "cm", path = paste0(file_path, "/demultiplex_055/") )

# should be same as above
DimPlot(subset1, group.by = "HTO_maxID") +
  labs(title = "RNA UMAP HTO_maxID on HTO-1:4 055")

subset2 <- subset(scCHANTS_singlets, subset = HTO_classification %in% c("HTO-7", "HTO-8", "HTO-9", "HTO-10") )
DimPlot(subset2, group.by = "HTO_classification")
```

Check the HTO signal
```{r}
# check HTO counts
HTO_counts <- GetAssayData(scCHANTS_055, assay = "HTO", layer = "counts")
HTO_counts <- data.frame(HTO_UMIs = Matrix::colSums(HTO_counts))
summary(HTO_counts$HTO_UMIs)

## checked HTOs are labelled as antibody capture in cell ranger
# check library size
d9 <- ggplot(HTO_counts, aes(x = HTO_UMIs)) +
  geom_histogram(bins = 150, fill = "steelblue", color = "black") +
  labs(main = "Total HTO UMIs per Cell 055", xlab = "HTO UMIs") +
  theme_minimal() +
  xlim(0,10000)
d9
## not peaking around 0 which is good
# ggsave("HTO_umis_per_cell_histogram_055.png", plot = d9, device = png, bg = "white", height = 7, width = 12, unit = "cm", path = paste0(file_path, "/demultiplex_055/") )


```


## Filter to only singlets
```{r}
scCHANTS_full <- scCHANTS_055
length(Cells(scCHANTS_full))

scCHANTS_055 <- subset(scCHANTS_055, subset = HTO_classification.global == "Singlet")

# check cell numbers
length(Cells(scCHANTS_055))
length(Cells(scCHANTS_055[["RNA"]]))
length(Cells(scCHANTS_055[["HTO"]]))
length(Cells(scCHANTS_055[["ADT"]]))
## not subsetting RNA assay
```

### Remove demultiplexing plots etc to save memory
```{r}
# remove objects
rm(name_to_id, adt_mat, subset1, subset2, scCHANTS_nonegs, scCHANTS_singlets)

# remove demultiplexing plots
rm(d1, d2, d3, d4, d5, d6, d7, d8, d9)

```


## Add metadata
```{r}
# examine existing metadata
metadata <- scCHANTS_055@meta.data

dim(metadata)
head(metadata)
summary(metadata$nCount_RNA)

# read in additional sample metadata
#metadata_samples <- read.csv("/scratch/prj/id_hill_sims_wellcda/scCHANTS/sample_metadata.csv")
metadata_samples <- read.csv("/Users/k2477939/Library/CloudStorage/OneDrive-King\'sCollegeLondon/General\ -\ Laboratory\ of\ Molecular\ Immunotherapy\ and\ Antibiotics/Data/Georgia\ Miller/scCHANTS/sample_metadata.csv")


head(metadata_samples)

# steps to add to seurat object

# check HTO values are all singles, no doublets
table(scCHANTS_055$HTO_classification.global) 
table(scCHANTS_055$HTO_classification)

# align each cell's HTO id to row in the metadata_samples, rownames here represent HTOs but can't have duplicate rownames hence 4.1 etc
hto_info <- metadata_samples[match(scCHANTS_055$HTO_classification, metadata_samples$HTO), ]
head(hto_info)

# add each row to new variable in metadata
scCHANTS_055$sample_id <- hto_info$sample
scCHANTS_055$timepoint <- hto_info$timepoint
scCHANTS_055$treatment <- hto_info$treatment
scCHANTS_055$PBMC_or_T <- hto_info$PBMC_or_T

# here also reorder HTO levels (get all unique levels, order numerically and factorise HTO_classification metadata column)
hto_levels <- unique(scCHANTS_055$HTO_classification)
hto_levels <- hto_levels[order(as.numeric(sub("HTO-", "", hto_levels)))]
scCHANTS_055$HTO_classification <- factor(
  scCHANTS_055$HTO_classification,
  levels = hto_levels
)

# check same number of cells for hto as sample
table(scCHANTS_055$sample_id)
table(scCHANTS_055$HTO_classification)

# check new metadata
metadata <- scCHANTS_055@meta.data

dim(metadata)
dim(scCHANTS_055) # check number of cells is same
colnames(metadata)
metadata[14:17, 14:17]
```

## Separate PBMC and sorted T cell samples
Check all assays have same number of cells after
```{r}
# order timepoints
timepoint_levels <- c("0", "7", "28", "benchmark")
scCHANTS_055$timepoint <- factor(
  scCHANTS_055$timepoint,
  levels = timepoint_levels
)

print("Full scCHANTS")
DefaultAssay(scCHANTS_055) <- "RNA"
length(Cells(scCHANTS_055@assays$RNA))
length(Cells(scCHANTS_055@assays$HTO))
length(Cells(scCHANTS_055@assays$ADT))

print("PBMC filtered scCHANTS")
scCHANTS_pbmc_055 <- subset(scCHANTS_055, subset = PBMC_or_T == "PBMC")
length(Cells(scCHANTS_pbmc_055@assays$RNA))
length(Cells(scCHANTS_pbmc_055@assays$HTO))
length(Cells(scCHANTS_pbmc_055@assays$ADT))

# keep benchmark in T cell samples for now
print("T cells filtered scCHANTS")
scCHANTS_t_055 <- subset(scCHANTS_055, subset = PBMC_or_T == "T" | sample_id == "13")
length(Cells(scCHANTS_t_055@assays$RNA))
length(Cells(scCHANTS_t_055@assays$HTO))
length(Cells(scCHANTS_t_055@assays$ADT))
```





# Script 2.1a PBMC Quality Control
## Quality control on PBMCs
```{r fig.dim = c(7,8)}
# calculate mt contamination and add column to metadata
scCHANTS_pbmc_055[["percent_mt"]] <- PercentageFeatureSet(scCHANTS_pbmc_055, pattern = "^MT-")

# calculate mt contamination and add column to metadata
scCHANTS_pbmc_055[["percent_rb"]] <- PercentageFeatureSet(scCHANTS_pbmc_055, pattern = "^RP[SL]")

# plot on violin plot
qc1 <- VlnPlot(scCHANTS_pbmc_055, features = c("nFeature_RNA", "nCount_RNA", "percent_mt", "percent_rb"), group.by = "timepoint", ncol = 2, alpha = 0.3)
## before filtering if mt counts are at 0 check you're in RNA assay as default, check head(rownames(scCHANTS_pbmc_055)) shows gene names
qc1
# ggsave("QC_violinplots_055.png", plot = qc1, device = png, height = 20, width = 20, unit = "cm", path = paste0(file_path, "/PBMC_plots/QC_055/") )

```


```{r}
# can look in more detail if needed e.g.
VlnPlot(scCHANTS_pbmc_055, features = "nFeature_RNA", group.by = "timepoint") +
  coord_cartesian(ylim = c(0, 1500)) +
  scale_y_continuous(n.breaks = 10) 

VlnPlot(scCHANTS_pbmc_055, features = "nFeature_RNA", group.by = "timepoint") +
  coord_cartesian(ylim = c(1500, 4000)) +
  scale_y_continuous(n.breaks = 10) 

# one cell here has extremely high mt (80%) so must control axes to look at the majority of cells
VlnPlot(scCHANTS_pbmc_055, features = "percent_mt", group.by = "timepoint") +
  coord_cartesian(ylim = c(0, 10))  +
  scale_y_continuous(n.breaks = 10) 


# feature scatter
ft <- FeatureScatter(scCHANTS_pbmc_055, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", group.by = "timepoint") +
  theme(legend.position="none")
mt <- FeatureScatter(scCHANTS_pbmc_055, feature1 = "nCount_RNA", feature2 = "percent_mt", group.by = "timepoint") + 
  coord_cartesian(ylim = c(0, 20)) +
  theme(legend.position="none")
rb <- FeatureScatter(scCHANTS_pbmc_055, feature1 = "nCount_RNA", feature2 = "percent_rb", group.by = "timepoint") +
  theme(legend.position="none")
mt_rb <- FeatureScatter(scCHANTS_pbmc_055, feature1 = "percent_mt", feature2 = "percent_rb", group.by = "timepoint") +
  coord_cartesian(xlim = c(0, 20)) +
  theme(legend.position="none")
qc2 <- (ft + mt) / (rb + mt_rb)
qc2
# ggsave("QC_scatterplots_055.png", plot = qc2, device = png, height = 18, width = 20, unit = "cm", path = paste0(file_path, "/PBMC_plots/QC_055/") )

# to see legend
FeatureScatter(scCHANTS_pbmc_055, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", group.by = "timepoint")


# plot timepoints separately instead, colour by sample
Idents(scCHANTS_pbmc_055) <- "sample_id"
ft2 <- FeatureScatter(scCHANTS_pbmc_055, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", split.by = "timepoint") +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))
mt2 <- FeatureScatter(scCHANTS_pbmc_055, feature1 = "nCount_RNA", feature2 = "percent_mt", split.by = "timepoint") + 
  theme(legend.position="none") +
  coord_cartesian(ylim = c(0, 20)) +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))
rb2 <- FeatureScatter(scCHANTS_pbmc_055, feature1 = "nCount_RNA", feature2 = "percent_rb", split.by = "timepoint") +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))
mt_rb2 <- FeatureScatter(scCHANTS_pbmc_055, feature1 = "percent_mt", feature2 = "percent_rb", split.by = "timepoint") +
  theme(legend.position="none") +
  coord_cartesian(xlim = c(0, 20)) +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))
qc3 <- (ft2 + mt2) / (rb2 + mt_rb2)
qc3
# ggsave("QC_scatterplots_split_055.png", plot = qc3, device = png, height = 18, width = 35, unit = "cm", path = paste0(file_path, "/PBMC_plots/QC_055/") )

# to see legend
FeatureScatter(scCHANTS_pbmc_055, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", split.by = "timepoint")

```

## Do subsetting
```{r}
# can subset straightaway based on QC metrics e.g. :
#scCHANTS_pbmc_055 <- subset(scCHANTS_pbmc_055, subset = nFeature_RNA > 1100  & nFeature_RNA < 4000 & percent_mt < 7) 

# or assign new metadata column
# start with all cells labeled as "initial"
scCHANTS_pbmc_055$QC <- "initial"

# label low nFeature_RNA (< 1100)
## i.e. if nFeature_RNA < 1100 (and previously passed QC as cautionary step), call it low_nFeature, otherwise leave as initial

scCHANTS_pbmc_055$QC <- ifelse(
  scCHANTS_pbmc_055$nFeature_RNA < 1100 & scCHANTS_pbmc_055$QC == "initial",
  "low_nFeature",
  scCHANTS_pbmc_055$QC
)

# label high nFeature_RNA (> 4000)
scCHANTS_pbmc_055$QC <- ifelse(
  scCHANTS_pbmc_055$nFeature_RNA > 4000 & scCHANTS_pbmc_055$QC == "initial",
  "high_nFeature",
  scCHANTS_pbmc_055$QC
)

# label high mitochondrial content (> 7%)
scCHANTS_pbmc_055$QC <- ifelse(
  scCHANTS_pbmc_055$percent_mt > 7 & scCHANTS_pbmc_055$QC == "initial",
  "high_mt",
  scCHANTS_pbmc_055$QC
)

# label combined: low_nFeature + high_mt
scCHANTS_pbmc_055$QC <- ifelse(
  scCHANTS_pbmc_055$nFeature_RNA < 1100 & scCHANTS_pbmc_055$percent_mt > 7 & scCHANTS_pbmc_055$QC != "pass",
  "low_nFeature_high_mt",
  scCHANTS_pbmc_055$QC
)

# label combined: high_nFeature + high_mt
scCHANTS_pbmc_055$QC <- ifelse(
  scCHANTS_pbmc_055$nFeature_RNA > 4000 & scCHANTS_pbmc_055$percent_mt > 7 & scCHANTS_pbmc_055$QC != "pass",
  "high_nFeature_high_mt",
  scCHANTS_pbmc_055$QC
)

# finally, label cells that pass all filters
scCHANTS_pbmc_055$QC <- ifelse(
  scCHANTS_pbmc_055$nFeature_RNA >= 1100 &
    scCHANTS_pbmc_055$nFeature_RNA <= 4000 &
    scCHANTS_pbmc_055$percent_mt <= 7 &
    scCHANTS_pbmc_055$QC == "initial",
  "pass",
  scCHANTS_pbmc_055$QC
)

```

## Replot QC plots, separated by QC result
```{r}
# look at proportion of QC results
table(scCHANTS_pbmc_055@meta.data$QC)

pbmc_qc <- table(scCHANTS_pbmc_055@meta.data$QC) %>%  
  as.data.frame() %>% 
  mutate(percent = Freq / sum(Freq) * 100)

qc4 <- ggplot(pbmc_qc, mapping = aes(x = Var1, y = percent, fill = Var1)) +
  theme_minimal() +
  geom_col() +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))
qc4
# ggsave("QC_barplot_postQC_055.png", plot = qc4, device = png, bg = "white", height = 8, width = 15, unit = "cm", path = paste0(file_path, "/PBMC_plots/QC_055/") )
```


```{r fig.dim = c(7,10)}
# plot on violin plot
qc5 <- VlnPlot(scCHANTS_pbmc_055, features = c("nFeature_RNA", "nCount_RNA", "percent_mt", "percent_rb"), ncol = 2, alpha = 0.3, group.by = "QC")
qc5
# ggsave("QC_violinplots_postQC_055.png", plot = qc5, device = png, height = 25, width = 20, unit = "cm", path = paste0(file_path, "/PBMC_plots/QC_055/") )

# feature scatter, coloured by QC overlaid
ft3 <- FeatureScatter(scCHANTS_pbmc_055, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", split.by = "timepoint", group.by = "QC") +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
mt3 <- FeatureScatter(scCHANTS_pbmc_055, feature1 = "nCount_RNA", feature2 = "percent_mt", split.by = "timepoint", group.by = "QC") + 
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
rb3 <- FeatureScatter(scCHANTS_pbmc_055, feature1 = "nCount_RNA", feature2 = "percent_rb", split.by = "timepoint", group.by = "QC") +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
mt_rb3 <- FeatureScatter(scCHANTS_pbmc_055, feature1 = "percent_mt", feature2 = "percent_rb", split.by = "timepoint", group.by = "QC") 
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
qc6 <- (ft3 + mt3) / (rb3 + mt_rb3)
qc6
# ggsave("QC_scatterplots_postQC_055.png", plot = qc6, device = png, height = 18, width = 35, unit = "cm", path = paste0(file_path, "/PBMC_plots/QC_055/") )
```


```{r fig.dim = c(10,10)}
# feature scatter, coloured by QC split
ft4 <- FeatureScatter(scCHANTS_pbmc_055, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", split.by = "QC", group.by = "QC") +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
mt4 <- FeatureScatter(scCHANTS_pbmc_055, feature1 = "nCount_RNA", feature2 = "percent_mt", split.by = "QC", group.by = "QC") + 
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
rb4 <- FeatureScatter(scCHANTS_pbmc_055, feature1 = "nCount_RNA", feature2 = "percent_rb", split.by = "QC", group.by = "QC") +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
mt_rb4 <- FeatureScatter(scCHANTS_pbmc_055, feature1 = "percent_mt", feature2 = "percent_rb", split.by = "QC", group.by = "QC") +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
qc7 <- (ft4 + mt4) / (rb4 + mt_rb4)
qc7
# ggsave("QC_scatterplots_postQC_split_055.png", plot = qc7, device = png, height = 18, width = 35, unit = "cm", path = paste0(file_path, "/PBMC_plots/QC_055/") )
```

Subset QCd PBMCs
```{r}
scCHANTS_pbmc_055 <- subset(scCHANTS_pbmc_055, subset = QC == "pass")
length(Cells(scCHANTS_pbmc_055@assays$RNA))
length(Cells(scCHANTS_pbmc_055@assays$HTO))
length(Cells(scCHANTS_pbmc_055@assays$ADT))
```

## Remove QC plots to save memory
```{r}
rm(ft, ft2, ft3, ft4, mt, mt2, mt3, mt4, mt_rb, mt_rb2, mt_rb3, mt_rb4, pbmc_qc, qc1, qc2, qc3, qc4, qc5, qc6, qc7, rb, rb2, rb3, rb4) 
```




# Script 2.1b T cell Quality Control
## Quality control on ts
```{r fig.dim = c(7,8)}
# calculate mt contamination and add column to metadata
scCHANTS_t_055[["percent_mt"]] <- PercentageFeatureSet(scCHANTS_t_055, pattern = "^MT-")

# calculate mt contamination and add column to metadata
scCHANTS_t_055[["percent_rb"]] <- PercentageFeatureSet(scCHANTS_t_055, pattern = "^RP[SL]")

# plot on violin plot
qc1 <- VlnPlot(scCHANTS_t_055, features = c("nFeature_RNA", "nCount_RNA", "percent_mt", "percent_rb"), group.by = "timepoint", ncol = 2, alpha = 0.3)
## before filtering if mt counts are at 0 check you're in RNA assay as default, check head(rownames(scCHANTS_t_055)) shows gene names
qc1
# ggsave("QC_violinplots_055.png", plot = qc1, device = png, height = 20, width = 20, unit = "cm", path = paste0(file_path, "/t_plots/QC_055/") )

```


```{r}
# can look in more detail if needed e.g.
VlnPlot(scCHANTS_t_055, features = "nFeature_RNA", group.by = "timepoint") +
  coord_cartesian(ylim = c(0, 1500)) +
  scale_y_continuous(n.breaks = 10) 

VlnPlot(scCHANTS_t_055, features = "nFeature_RNA", group.by = "timepoint") +
  coord_cartesian(ylim = c(1500, 4000)) +
  scale_y_continuous(n.breaks = 10) 

# one cell here has extremely high mt (80%) so must control axes to look at the majority of cells
VlnPlot(scCHANTS_t_055, features = "percent_mt", group.by = "timepoint") +
  coord_cartesian(ylim = c(0, 10))  +
  scale_y_continuous(n.breaks = 10) 


# feature scatter
ft <- FeatureScatter(scCHANTS_t_055, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", group.by = "timepoint") +
  theme(legend.position="none")
mt <- FeatureScatter(scCHANTS_t_055, feature1 = "nCount_RNA", feature2 = "percent_mt", group.by = "timepoint") + 
  coord_cartesian(ylim = c(0, 20)) +
  theme(legend.position="none")
rb <- FeatureScatter(scCHANTS_t_055, feature1 = "nCount_RNA", feature2 = "percent_rb", group.by = "timepoint") +
  theme(legend.position="none")
mt_rb <- FeatureScatter(scCHANTS_t_055, feature1 = "percent_mt", feature2 = "percent_rb", group.by = "timepoint") +
  coord_cartesian(xlim = c(0, 20)) +
  theme(legend.position="none")
qc2 <- (ft + mt) / (rb + mt_rb)
qc2
# ggsave("QC_scatterplots_055.png", plot = qc2, device = png, height = 18, width = 20, unit = "cm", path = paste0(file_path, "/t_plots/QC_055/") )

# to see legend
FeatureScatter(scCHANTS_t_055, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", group.by = "timepoint")


# plot timepoints separately instead, colour by sample
Idents(scCHANTS_t_055) <- "sample_id"
ft2 <- FeatureScatter(scCHANTS_t_055, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", split.by = "timepoint") +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))
mt2 <- FeatureScatter(scCHANTS_t_055, feature1 = "nCount_RNA", feature2 = "percent_mt", split.by = "timepoint") + 
  theme(legend.position="none") +
  coord_cartesian(ylim = c(0, 20)) +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))
rb2 <- FeatureScatter(scCHANTS_t_055, feature1 = "nCount_RNA", feature2 = "percent_rb", split.by = "timepoint") +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))
mt_rb2 <- FeatureScatter(scCHANTS_t_055, feature1 = "percent_mt", feature2 = "percent_rb", split.by = "timepoint") +
  theme(legend.position="none") +
  coord_cartesian(xlim = c(0, 20)) +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))
qc3 <- (ft2 + mt2) / (rb2 + mt_rb2)
qc3
# ggsave("QC_scatterplots_split_055.png", plot = qc3, device = png, height = 18, width = 35, unit = "cm", path = paste0(file_path, "/t_plots/QC_055/") )

# to see legend
FeatureScatter(scCHANTS_t_055, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", split.by = "timepoint")

```

## Do subsetting
```{r}
# can subset straightaway based on QC metrics e.g. :
#scCHANTS_t_055 <- subset(scCHANTS_t_055, subset = nFeature_RNA > 1100  & nFeature_RNA < 4000 & percent_mt < 7) 

# or assign new metadata column
# start with all cells labeled as "initial"
scCHANTS_t_055$QC <- "initial"

# label low nFeature_RNA (< 1100)
## i.e. if nFeature_RNA < 1100 (and previously passed QC as cautionary step), call it low_nFeature, otherwise leave as initial

scCHANTS_t_055$QC <- ifelse(
  scCHANTS_t_055$nFeature_RNA < 1100 & scCHANTS_t_055$QC == "initial",
  "low_nFeature",
  scCHANTS_t_055$QC
)

# label high nFeature_RNA (> 4000)
scCHANTS_t_055$QC <- ifelse(
  scCHANTS_t_055$nFeature_RNA > 4000 & scCHANTS_t_055$QC == "initial",
  "high_nFeature",
  scCHANTS_t_055$QC
)

# label high mitochondrial content (> 7%)
scCHANTS_t_055$QC <- ifelse(
  scCHANTS_t_055$percent_mt > 7 & scCHANTS_t_055$QC == "initial",
  "high_mt",
  scCHANTS_t_055$QC
)

# label combined: low_nFeature + high_mt
scCHANTS_t_055$QC <- ifelse(
  scCHANTS_t_055$nFeature_RNA < 1100 & scCHANTS_t_055$percent_mt > 7 & scCHANTS_t_055$QC != "pass",
  "low_nFeature_high_mt",
  scCHANTS_t_055$QC
)

# label combined: high_nFeature + high_mt
scCHANTS_t_055$QC <- ifelse(
  scCHANTS_t_055$nFeature_RNA > 4000 & scCHANTS_t_055$percent_mt > 7 & scCHANTS_t_055$QC != "pass",
  "high_nFeature_high_mt",
  scCHANTS_t_055$QC
)

# finally, label cells that pass all filters
scCHANTS_t_055$QC <- ifelse(
  scCHANTS_t_055$nFeature_RNA >= 1100 &
    scCHANTS_t_055$nFeature_RNA <= 4000 &
    scCHANTS_t_055$percent_mt <= 7 &
    scCHANTS_t_055$QC == "initial",
  "pass",
  scCHANTS_t_055$QC
)

```

## Replot QC plots, separated by QC result
```{r}
# look at proportion of QC results
table(scCHANTS_t_055@meta.data$QC)

t_qc <- table(scCHANTS_t_055@meta.data$QC) %>%  
  as.data.frame() %>% 
  mutate(percent = Freq / sum(Freq) * 100)

qc4 <- ggplot(t_qc, mapping = aes(x = Var1, y = percent, fill = Var1)) +
  theme_minimal() +
  geom_col() +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))
qc4
# ggsave("QC_barplot_postQC_055.png", plot = qc4, device = png, bg = "white", height = 8, width = 15, unit = "cm", path = paste0(file_path, "/t_plots/QC_055/") )
```


```{r fig.dim = c(7,10)}
# plot on violin plot
qc5 <- VlnPlot(scCHANTS_t_055, features = c("nFeature_RNA", "nCount_RNA", "percent_mt", "percent_rb"), ncol = 2, alpha = 0.3, group.by = "QC")
qc5
# ggsave("QC_violinplots_postQC_055.png", plot = qc5, device = png, height = 25, width = 20, unit = "cm", path = paste0(file_path, "/t_plots/QC_055/") )

# feature scatter, coloured by QC overlaid
ft3 <- FeatureScatter(scCHANTS_t_055, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", split.by = "timepoint", group.by = "QC") +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
mt3 <- FeatureScatter(scCHANTS_t_055, feature1 = "nCount_RNA", feature2 = "percent_mt", split.by = "timepoint", group.by = "QC") + 
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
rb3 <- FeatureScatter(scCHANTS_t_055, feature1 = "nCount_RNA", feature2 = "percent_rb", split.by = "timepoint", group.by = "QC") +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
mt_rb3 <- FeatureScatter(scCHANTS_t_055, feature1 = "percent_mt", feature2 = "percent_rb", split.by = "timepoint", group.by = "QC") 
theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
qc6 <- (ft3 + mt3) / (rb3 + mt_rb3)
qc6
# ggsave("QC_scatterplots_postQC_055.png", plot = qc6, device = png, height = 18, width = 35, unit = "cm", path = paste0(file_path, "/t_plots/QC_055/") )
```


```{r fig.dim = c(10,10)}
# feature scatter, coloured by QC split
ft4 <- FeatureScatter(scCHANTS_t_055, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", split.by = "QC", group.by = "QC") +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
mt4 <- FeatureScatter(scCHANTS_t_055, feature1 = "nCount_RNA", feature2 = "percent_mt", split.by = "QC", group.by = "QC") + 
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
rb4 <- FeatureScatter(scCHANTS_t_055, feature1 = "nCount_RNA", feature2 = "percent_rb", split.by = "QC", group.by = "QC") +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
mt_rb4 <- FeatureScatter(scCHANTS_t_055, feature1 = "percent_mt", feature2 = "percent_rb", split.by = "QC", group.by = "QC") +
  #theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
qc7 <- (ft4 + mt4) / (rb4 + mt_rb4)
qc7
# ggsave("QC_scatterplots_postQC_split_055.png", plot = qc7, device = png, height = 18, width = 35, unit = "cm", path = paste0(file_path, "/t_plots/QC_055/") )
```

Subset QCd ts
```{r}
scCHANTS_t_055 <- subset(scCHANTS_t_055, subset = QC == "pass")
length(Cells(scCHANTS_t_055@assays$RNA))
length(Cells(scCHANTS_t_055@assays$HTO))
length(Cells(scCHANTS_t_055@assays$ADT))
```

## Remove QC plots to save memory
```{r}
rm(ft, ft2, ft3, ft4, mt, mt2, mt3, mt4, mt_rb, mt_rb2, mt_rb3, mt_rb4, t_qc, qc1, qc2, qc3, qc4, qc5, qc6, qc7, rb, rb2, rb3, rb4) 
```



