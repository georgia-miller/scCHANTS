---
title: "script_2.3a_annotation_pbmc_20250805"
author: "GKM"
date: "2025-08-18"
output:
  html_document:
    keep_md: TRUE
---

In script 2.1 and 2.2a, the 20250508 data was loaded, HTOs demultiplexed, filtered for QC, then dimensional reduction and clustering was performed. The processed seurat object was saved as were the cluster biomarkers.

These can now be read in to avoid repeating the prior steps.

This script focuses on cell type classificaiton/annotation.

```{r}
library("dplyr")
library("Seurat")
library("ggplot2")
library("readr")
library("patchwork")

```

# Create file path for saving plots
```{r}
#file_path <- "/scratch/prj/id_hill_sims_wellcda/scCHANTS/20250805_run1/"
file_path <- "/Users/k2477939/Library/CloudStorage/OneDrive-King\'sCollegeLondon/General\ -\ Laboratory\ of\ Molecular\ Immunotherapy\ and\ Antibiotics/Data/Georgia\ Miller/scCHANTS/"

plot_path <- paste0(file_path, "20250805_run1/plots/PBMC_plots/")
```

```{r}
# load seurat object
scCHANTS_pbmc <- readRDS(paste0(file_path, "20250805_run1/20250805_scCHANTS_pbmc_processed.Rds"))

# check has pca and umap saved
names(scCHANTS_pbmc@reductions)

# check has RNA_snn_res column with cell_types
colnames(scCHANTS_pbmc@meta.data)

Idents(scCHANTS_pbmc) <- "seurat_clusters"
DefaultAssay(scCHANTS_pbmc) <- "SCT"

metadata <- scCHANTS_pbmc@meta.data

# load in cluster markers
pbmc_markers <- read_csv(paste0(file_path, "20250805_run1/20250805_scCHANTS_pbmc_markers.csv"))

head(pbmc_markers)

```

# Look at cluster markers
can also: Classification power, ROC test while running findmarkers returns value 0-1 (random-perfect classification):
cluster0.markers <- FindMarkers(scCHANTS_pbmc, ident.1 = 0, logfc.threshold = 0.25, test.use = "roc", only.pos = TRUE)
    
```{r fig.dim = c(10,15)}
pbmc_markers %>%
  group_by(cluster) %>%
  dplyr::filter(avg_log2FC > 1) %>% 
  arrange(avg_log2FC) %>% 
  head()

top10 <- pbmc_markers %>%
    group_by(cluster) %>%
    dplyr::filter(avg_log2FC > 1) %>%
    slice_head(n = 10) %>% # take top 10 genes for each cluster
    ungroup()
top10

c1 <- DoHeatmap(scCHANTS_pbmc, features = top10$gene) 
  NoLegend()
c1
# ggsave("top10_markers_heatmap.png", plot = c1, device = png, width = 17, height = 25, unit = "cm", path = paste0(plot_path, "cell_types/"))
```

```{r}
c2 <- DimPlot(scCHANTS_pbmc, group.by = "seurat_clusters", label = TRUE)
c2
# ggsave("by_clusters_umap.png", plot = c2, device = png, width = 15, height = 10, unit = "cm", path = paste0(file_path, "/cell_types/") )
```

```{r fig.dim = c(15,15)}
# 1 marker for each cluster
c3 <- FeaturePlot(scCHANTS_pbmc, features = c("ITK", "IL1B", "CD74", "CRIP1", "GNLY", "CD74", "SELL", "RGCC", "CD8A", "TXN", "MT1X", "LINC02211"))
c3
# ggsave("top_marker_featureplots.png", plot = c3, device = png, width = 25, height = 20, unit = "cm", path = paste0(file_path, "/cell_types/") )

c4 <- VlnPlot(scCHANTS_pbmc, features = c("ITK", "IL1B", "CD74", "CRIP1", "GNLY", "CD74", "SELL", "RGCC", "CD8A", "TXN", "MT1X", "LINC02211"))
c4
# ggsave("top_marker_vlnplots.png", plot = c4, device = png, width = 25, height = 20, unit = "cm", path = paste0(file_path, "/cell_types/") )

```

# Cell type classification 

## Oelen et al markers
###  Load known cell type markers
```{r fig.dim = c(12,10)}
# plot dotplot of expected cell types for markers
# read in binary tables for specific and broad cell types
markers_binary_sp <- read_csv(paste0(file_path, "marker_genes/Oelen/marker_genes_binary_specificcelltypes.csv"))

markers_binary_br <- read_csv(paste0(file_path, "marker_genes/Oelen/marker_genes_binary_broadcelltypes.csv"))
         
# has only broad cell types but all gene markers so can compare directly
markers_binary_br2 <- read_csv(paste0(file_path, "marker_genes/Oelen/marker_genes_binary_broadcelltypes_allmarkers.csv"))

# make into long format so can plot dotplot
markers_long_sp <- markers_binary_sp %>%
  pivot_longer(
    cols = -marker,
    names_to = "cell_type",
    values_to = "value"
  ) %>% 
  mutate(marker = factor(marker,
                         levels = c("CD3D", "CD3E", "CD3G", "CCR7", "SELL", "CD8A", "CD8B", "LTB", "IL7R", "S100A4", "GZMB", "PRF1", "FCGR3A", "NKG7", "GNLY", "KLRC1", "CD14", "LYZ", "S100A9", "CSF3R", "CSF1R", "LYN", "IFITM1", "IFITM2", "IFITM3", "CD79A", "MS4A1", "CD1C", "ITGAX", "CLEC4C", "GP9", "ITGA2B", "PF4", "PPBP")),
          cell_type = factor(cell_type,
                             levels = c("CD4_naive", "CD4_memory", "CD8_naive", "CD8_memory", "NK_dim", "NK_bright", "mono_classic", "mono_nonclassic", "B_normal", "B_plasma", "DC_myeloid", "DC_plasmacytoid", "megak")))

markers_long_br <- markers_binary_br %>%
  pivot_longer(
    cols = -marker,
    names_to = "cell_type",
    values_to = "value"
  ) %>% 
  mutate(marker = factor(marker,
                         levels = c("CD3D", "CD3E", "CD3G", "CD8A", "CD8B", "GZMB", "PRF1", "CD14", "CD79A", "GP9", "ITGA2B", "PF4", "PPBP")),
         cell_type = factor(cell_type,
                             levels = c("CD4T", "CD8T", "NK", "mono", "B", "DC", "megak")))

markers_long_br2 <- markers_binary_br2 %>%
  pivot_longer(
    cols = -marker,
    names_to = "cell_type",
    values_to = "value"
  ) %>% 
  mutate(marker = factor(marker,
                         levels = c("CD3D", "CD3E", "CD3G", "CCR7", "SELL", "CD8A", "CD8B", "LTB", "IL7R", "S100A4", "GZMB", "PRF1", "FCGR3A", "NKG7", "GNLY", "KLRC1", "CD14", "LYZ", "S100A9", "CSF3R", "CSF1R", "LYN", "IFITM1", "IFITM2", "IFITM3", "CD79A", "MS4A1", "CD1C", "ITGAX", "CLEC4C", "GP9", "ITGA2B", "PF4", "PPBP")),
          cell_type = factor(cell_type,
                             levels = c("CD4T", "CD8T", "NK", "mono", "B", "DC", "megak")))

```

```{r fig.dim = c(12,10)}
m1 <- ggplot(markers_long_sp, aes(x = marker, y = cell_type)) +
  geom_point(aes(size = abs(value), fill = as.factor(value)), shape = 21, color = "black") +
  coord_flip() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))
m1
#ggsave("specific_celltype_by_markerexp_dotplot.png", plot = m1, device = png, width = 16, height = 12, unit = "cm", bg = "white", path = paste0(file_path, "marker_genes/Oelen/") )

m2 <- ggplot(markers_long_br, aes(x = marker, y = cell_type)) +
  geom_point(aes(size = abs(value), fill = as.factor(value)), shape = 21, color = "black") +
  coord_flip() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))
m2
#ggsave("broad_celltype_by_markerexp_dotplot.png", plot = m2, device = png, width = 16, height = 12, unit = "cm", bg = "white", path = paste0(file_path, "marker_genes/Oelen/") )

m3 <- ggplot(markers_long_br2, aes(x = marker, y = cell_type)) +
  geom_point(aes(size = abs(value), fill = as.factor(value)), shape = 21, color = "black") +
  coord_flip() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))
m3
#ggsave("broad_celltype_by_allmarkerexp_dotplot.png", plot = m3, device = png, width = 16, height = 12, unit = "cm", bg = "white", path = paste0(file_path, "marker_genes/Oelen/") )

```

### Dotplots
```{r fig.dim = c(12,10)}
marker_genes_broad <- c("CD3D", "CD3E", "CD3G", "CD8A", "CD8B", "GZMB", "PRF1", "CD14", "CD79A", "GP9", "ITGA2B", "PF4", "PPBP")

d1 <- DotPlot(scCHANTS_pbmc, features = marker_genes_broad, assay = "RNA", group.by = "seurat_clusters", cols = c("lightgrey", "blue")) +
  coord_flip() +
  ggtitle("scCHANTS PBMC cluster by marker exp run1")
d1

#ggsave("clusters_by_markerexp_dotplot_broad.pdf", plot = d1, device = pdf, width = 20, height = 14, unit = "cm", bg = "white", path = paste0(plot_path, "cell_types/") )
#ggsave("clusters_by_markerexp_dotplot_broad.png", plot = d1, device = png, width = 20, height = 14, unit = "cm", bg = "white", path = paste0(plot_path, "cell_types/") )


marker_genes <- c("CD3D", "CD3E", "CD3G", "CCR7", "SELL", "CD8A", "CD8B", "LTB", "IL7R", "S100A4", "GZMB", "PRF1", "FCGR3A", "NKG7", "GNLY", "KLRC1", "CD14", "LYZ", "S100A9", "CSF3R", "CSF1R", "LYN", "IFITM1", "IFITM2", "IFITM3", "CD79A", "MS4A1", "CD1C", "ITGAX", "CLEC4C", "GP9", "ITGA2B", "PF4", "PPBP")

d2 <- DotPlot(scCHANTS_pbmc, features = marker_genes, assay = "RNA", group.by = "seurat_clusters", cols = c("lightgrey", "blue")) +
  coord_flip() +
  ggtitle("scCHANTS PBMC cluster by marker exp run1")
d2

#ggsave("clusters_by_markerexp_dotplot.pdf", plot = d2, device = pdf, width = 20, height = 18, unit = "cm", bg = "white", path = paste0(plot_path, "cell_types/") )
#ggsave("clusters_by_markerexp_dotplot.png", plot = d2, device = png, width = 20, height = 18, unit = "cm", bg = "white", path = paste0(plot_path, "cell_types/") )

```

### Violin plots
```{r}
d3 <- VlnPlot(scCHANTS_pbmc, features = marker_genes_broad, assay = "RNA", group.by = "seurat_clusters", ncol = 3)
d3

#ggsave("clusters_by_markerexp_vlnplot_broad.png", plot = d3, device = png, width = 25, height = 40, unit = "cm", path = paste0(plot_path, "cell_types/") )


# change so when split into blocks of 9 plots, all monocytes are together (just switch B markers)
marker_genes1 <- c("CD3D", "CD3E", "CD3G", "CCR7", "SELL", "CD8A", "CD8B", "LTB", "IL7R", "S100A4", "GZMB", "PRF1", "FCGR3A", "NKG7", "GNLY", "KLRC1", "CD79A", "MS4A1", "CD14", "LYZ", "S100A9", "CSF3R", "CSF1R", "LYN", "IFITM1", "IFITM2", "IFITM3", "CD1C", "ITGAX", "CLEC4C", "GP9", "ITGA2B", "PF4", "PPBP")

d4 <- VlnPlot(scCHANTS_pbmc, features = marker_genes1, assay = "RNA", group.by = "seurat_clusters", ncol = 3)
d4
#ggsave("clusters_by_markerexp_vlnplot.png", plot = d4, device = png, width = 25, height = 96, unit = "cm", path = paste0(plot_path, "cell_types/") )

```

## Ben-Moshe et al markers
###  Load known cell type markers
```{r fig.dim = c(12,10)}
# plot dotplot of expected cell types for markers

# read in binary tables for specific and broad cell types
markers_binary_br_bm <- read_csv(paste0(file_path, "marker_genes/Ben-Moshe/marker_genes_binary_broadcelltypes_BM.csv"))
    
markers_long_br_bm <- markers_binary_br_bm %>%
  pivot_longer(
    cols = -marker,
    names_to = "cell_type",
    values_to = "value"
  ) %>% 
  mutate(marker = factor(marker,
                         levels = c("CD3D", "CD3E", "CD3G", "CD8A", "CD8B", "GZMB", "PRF1", "CD14", "CD79A", "GP9", "ITGA2B", "PF4", "PPBP")),
         cell_type = factor(cell_type,
                             levels = c("CD4T", "CD8T", "NK", "mono", "B", "DC", "megak")))

markers_long_br_bm <- markers_binary_br_bm %>%
  pivot_longer(
    cols = -marker,
    names_to = "cell_type",
    values_to = "value"
  ) %>% 
  mutate(marker = factor(marker,
                         levels = c("CD3D", "CD3G", "CD3E", "TRAC", "NKG7", "GNLY", "KLRD1", "GZMA", "GZMB", "PRF1", "HOPX", "MS4A4A", "MS4A7", "S100A9", "CYBB", "CTSD", "CTSB", "CTSL", "LYZ", "FSCN1", "LAMP3", "CXCL13", "CCL19", "CD79A", "CD79B", "MS4A1", "BANK1")),
          cell_type = factor(cell_type,
                             levels = c("T", "NK", "mono", "B", "DC")))

```

```{r fig.dim = c(12,10)}
m4 <- ggplot(markers_long_br_bm, aes(x = marker, y = cell_type)) +
  geom_point(aes(size = abs(value), fill = as.factor(value)), shape = 21, color = "black") +
  coord_flip() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))
m4
#ggsave("broad_celltype_by_BMmarkerexp_dotplot.png", plot = m4, device = png, width = 16, height = 12, unit = "cm", bg = "white", path = paste0(file_path, "marker_genes/Ben-Moshe") )

```

### Dotplots
```{r fig.dim = c(12,10)}
marker_genes_bm <- c("CD3D", "CD3G", "CD3E", "TRAC", "NKG7", "GNLY", "KLRD1", "GZMA", "GZMB", "PRF1", "HOPX", "MS4A4A", "MS4A7", "S100A9", "CYBB", "CTSD", "CTSB", "CTSL", "LYZ", "FSCN1", "LAMP3", "CXCL13", "CCL19", "CD79A", "CD79B", "MS4A1", "BANK1", "CD72")

d5 <- DotPlot(scCHANTS_pbmc, features = marker_genes_bm, assay = "RNA", group.by = "seurat_clusters", cols = c("lightgrey", "blue")) +
  coord_flip() +
  ggtitle("scCHANTS PBMC cluster by BM marker exp run1")
d5

#ggsave("clusters_by_BMmarkerexp_dotplot.pdf", plot = d5, device = pdf, width = 20, height = 14, unit = "cm", bg = "white", path = paste0(plot_path, "cell_types/") )
#ggsave("clusters_by_BMmarkerexp_dotplot.png", plot = d5, device = png, width = 20, height = 14, unit = "cm", bg = "white", path = paste0(plot_path, "cell_types/") )

```

### Violin plots
```{r}

d6 <- VlnPlot(scCHANTS_pbmc, features = marker_genes_bm, assay = "RNA", group.by = "seurat_clusters", ncol = 3)
d6
#ggsave("clusters_by_BMmarkerexp_vlnplot.png", plot = d6, device = png, width = 25, height = 96, unit = "cm", path = paste0(plot_path, "cell_types/") )

```

# More to do on clusters and markers but for now, give classification (see powerpoint) and move on to T cell subsetting
Add cell type per cluster
```{r}
# cluster no.   0    1    2    3    4    5    6    7     8    9    10     11       12         13
cell_type <- c("T", "T", "T", "T", "T", "T", "B", "NK", "B", "NK", "T", "mono", "unknown", "unknown" )

scCHANTS_pbmc$cell_type <- plyr::mapvalues(
  Idents(scCHANTS_pbmc),
  from = as.character(0:13),
  to = cell_type
)

Idents(scCHANTS_pbmc) <- "cell_type"

# reorder timepoint and treatment
scCHANTS_pbmc$timepoint <- factor(scCHANTS_pbmc$timepoint, levels = c("0", "7", "28", "benchmark"))
scCHANTS_pbmc$treatment <- factor(scCHANTS_pbmc$treatment, levels = c("UT", "T"))

metadata <- scCHANTS_pbmc@meta.data
colnames(metadata)
head(metadata$cell_type)
head(metadata$seurat_clusters)

p1 <- DimPlot(scCHANTS_pbmc, reduction = "umap", label = TRUE, group.by = "seurat_clusters")
p2 <- DimPlot(scCHANTS_pbmc, reduction = "umap", label = TRUE, group.by = "cell_type")
p3 <- p1|p2
p3

#ggsave("cell_type_classification_umap.png", plot = p3, device = png, width = 28, height = 12, unit = "cm", path = paste0(plot_path, "cell_types/") )

```

```{r}
DimPlot(scCHANTS_pbmc, reduction = "umap", group.by = "cell_type", split.by = "timepoint")

#ggsave("by_timepoint_umap.png", plot = p3, device = png, width = 28, height = 12, unit = "cm", path = plot_path)

# plot per donor per timepoint
x <- lapply(donors, function(X) {
  DimPlot(
    subset(scCHANTS_pbmc, donor == X),
    reduction = "umap",
    group.by = "cell_type",
    split.by = "timepoint"
  ) + 
    ggtitle(paste("Donor", X)) + 
    NoLegend()
})

p4 <- (x[[1]] | x[[2]]) / (x[[3]] | x[[4]])
p4

# or stacked on top of each other
p5 <- x[[1]] / x[[2]] / x[[3]] / x[[4]]
p5

#ggsave("cell_type_classification_by_donor_umap.png", plot = p4, device = png, width = 50, height = 20, unit = "cm", path = paste0(plot_path, "umaps/") )
#ggsave("cell_type_classification_by_donor_umap_2.png", plot = p5, device = png, width = 25, height = 35, unit = "cm", path = paste0(plot_path, "umaps/") )
```


```{r}
# cell type numbers etc
counts <- metadata %>% 
  group_by(donor, timepoint, cell_type) %>% 
  summarise(n_cells=n())  %>%
  # add proportions
  group_by(donor, timepoint) %>%
  mutate(proportion = n_cells / sum(n_cells)) %>%
  ungroup()

head(counts)

# bar chart of cell type number/distribution of each timepoint by cell type for each donor
p6 <- counts %>%  
  ggplot(mapping = aes(x = timepoint, y = n_cells, fill = cell_type)) +
  geom_bar(position = "stack", stat = "identity") +
  labs(title = "Cell type counts") +
  facet_wrap(facets = vars(donor))
p6

#ggsave("cell_type_numbers_per_donor_barplot.png", plot = p6, device = png, width = 15, height = 12, unit = "cm", path = paste0(plot_path, "cell_types/") )


# for all donors
p7 <- counts %>%  
  ggplot(mapping = aes(x = timepoint, y = n_cells, fill = cell_type)) +
  geom_bar(position = "stack", stat = "identity") +
  labs(title = "Cell type counts")
p7

#ggsave("cell_type_numbers_overall_barplot.png", plot = p7, device = png, width = 15, height = 12, unit = "cm", path = paste0(plot_path, "cell_types/") )


# split by cell type, fixed axes
p8 <- counts %>%  
  ggplot(mapping = aes(x = timepoint, y = n_cells, fill = donor)) +
  geom_bar(position = "stack", stat = "identity") +
  labs(title = "Cell type counts") +
  facet_wrap(facets = vars(cell_type)) +
  scale_fill_brewer(palette = "Accent")
p8

#ggsave("cell_type_numbers_by_celltype_fixed_barplot.png", plot = p8, device = png, width = 20, height = 12, unit = "cm", path = paste0(plot_path, "cell_types/") )


# split by cell type, free axes
p9 <- counts %>%  
  ggplot(mapping = aes(x = timepoint, y = n_cells, fill = donor)) +
  geom_bar(position = "stack", stat = "identity") +
  labs(title = "Cell type counts") +
  facet_wrap(facets = vars(cell_type), scales = "free_y") +
  scale_fill_brewer(palette = "Accent")
p9

#ggsave("cell_type_numbers_by_celltype_barplot.png", plot = p9, device = png, width = 20, height = 12, unit = "cm", path = paste0(plot_path, "cell_types/") )


# proportion bar chart of cell type number/distribution of each timepoint by cell type for each donor
p10 <- counts %>%  
  ggplot(mapping = aes(x = timepoint, y = proportion, fill = cell_type)) +
  geom_bar(position = "stack", stat = "identity") +
  labs(title = "Cell type proportion") +
  facet_wrap(facets = vars(donor))
p10

#ggsave("cell_type_proportion_per_donor_barplot.png", plot = p10, device = png, width = 15, height = 12, unit = "cm", path = paste0(plot_path, "cell_types/") )

```


```{r}
rm(counts, c1, c2, c3, c4, d1, d2, d3, d4, d5, d6, m1, m2, m3, m4, markers_binary_br, markers_binary_br_bm, markers_binary_br2, markers_binary_sp, markers_long_br, markers_long_br_bm, markers_long_br2, markers_long_sp, p1, p2, p3, p4, p5, p6, p7, p8, p9, p10, cell_type, marker_genes, marker_genes_bm, marker_genes_broad, marker_genes1, x)
```
